;;; -*- Mode:LISP; Package:MACSYMA -*-

;	** (c) Copyright 1981 Massachusetts Institute of Technology **

; Do a COMPLR^K and type ^G to quit.  Then load in this file.

; To compile files for a new MACSYMA, all you need do is type 
;    "(MSCOMP)" and hope for no bugs.  (Set FASLP to NIL first if 
;    you don't want FASL files created; Set REDOALL to T if you want 
;    all files recompiled.)

; Use "MAKLAP1" instead of "MAKLAP" to compile (and assemble, unless 
;    FASLP is set to NIL) a single file.  
;  Sample calls are:
;	(MAKLAP1 (RISCH > DSK JM))
;    to put the output on the MACSYM; (or MAXOUT;) directory. 
;  The two-arg. format e.g.
;	(MAKLAP1 (OUT FASL DSK WHO) (IN FILE DSK USER))
;    is also acceptable. 
;  (You may reset UNFASLCOMMENTSP (default T), NOLAPP (default T), 
;    TTYNOTESP (default T), YESWARNTTYP (default T),
;    MUZZLEDP (default NIL), and MAPEXP (default NIL).)

;;; Let files that need to know (e.g. MAXSRC;TRANS1 >) that we
;;; are compiling to INSTALL a new source.

(DEFUN SSTATUS-FEATURE-MACSYMA-COMPLR ()
       (EVAL
        (READLIST
	 '( /( S S T A T U S /  F E A T U R E /  M A C S Y M A - C O M P L R /) ))))
(SSTATUS-FEATURE-MACSYMA-COMPLR)

(SETQ OUT1 NIL UNDFUNL* NIL FASLP T REDOALL NIL TTYNOTESP T YESWARNTTYP T
      UNFASLCOMMENTSP T NOLAPP T MUZZLEDP NIL MMSDIR 'MUNFAS MAPEXP NIL
      FILEONE NIL)

(DEFPROP MACSYMA-MODULE MACSYMA-MODULE-MACRO MACRO)
(DEFPROP MACSYMA-MODULE-MACRO "DSK:LIBMAX;MODULE" AUTOLOAD)

; Format of files is: FILENAME1 > DSK Source

(PROG2 
 (SETQ FILES1  ; FASL file to MAXDMP; , UNFASL file to MUNFAS;
       '((DISPLA > DSK MRG) (NFORMA > DSK MRG) (GRAM > DSK MRG)
	 (COMPAR > DSK MRG) (TRIGI > DSK MRG) (DB > DSK MRG)
	 (GRIND > DSK MRG) (MLISP > DSK JPG)
	 (MEDIT > DSK JPG) (SUPRV > DSK JPG) (COMM > DSK JPG)
	 (DSKFN > DSK JPG) (CSIMP > DSK PAULW) (MAT > DSK PAULW)
	 (MATRIX > DSK PAULW) (LESFAC > DSK RAT) (FACTOR > DSK RAT)
	 (RAT3A > DSK RAT) (RAT3B > DSK RAT) (RAT3C > DSK RAT)
	 (RAT3D > DSK RAT) (RAT3E > DSK RAT) (NRAT4 > DSK RAT)
	 (OPERS > DSK MAXSRC) (UTILS > DSK MAXSRC)
	 (MUTILS > DSK MAXSRC) (MLOAD > DSK MAXSRC)
	 (SIMP > DSK JM) (RUNTIM > DSK MAXSRC) (INMIS > DSK MAXSRC)
	 (ASUM > DSK RZ) (SPGCD > DSK RAT) (ERMSGM > DSK MAXSRC)
	 (MERROR > DSK MAXSRC) (MFORMT > DSK MAXSRC)))
 'FILES1)

; The following files are not part of the core system 
(PROG2 
 (SETQ FILES2  ; FASL file to MACSYM; , UNFASL file to MUNFAS;
       '(;(TRANSL > DSK TRANSL) (TRANS1 > DSK TRANSL)
;  GJC's files no longer automatically compiled at the request of GJC. - JPG
;	 (TRMODE > DSK TRANSL) (TRANS4 > DSK TRANSL)
;	 (TRANS3 > DSK TRANSL)
;	 (TRDATA > DSK TRANSL) (FCALL > DSK TRANSL)
;	 (TRANS2 > DSK TRANSL) (ACALL > DSK TRANSL)
;	 (EVALW > DSK TRANSL) (UPDATE > DSK TRANSL)
	 (FORTRA > DSK MRG) (OPTION > DSK ELLEN) (PRIMER > DSK ELLEN)
	 (LDISP > DSK MAXSRC)
	 (SCS > DSK MRG) (OPTIM > DSK MRG) (SININT > DSK JM)
	 (SIN > DSK JM) (RISCH > DSK JM) (ZERO > DSK JM)
	 (MATCOM > DSK RAT) (MATRUN > DSK RAT)
	 (POIS2 > DSK RAT) (POIS3 > DSK RAT)
	 (RATPOI > DSK RAT) (FLOAT > DSK RAT) (SOLVE > DSK RAT)
	 (MDOT > DSK MAXSRC)
	 (ARDS > DSK MAXSRC) (H19 > DSK MAXSRC) (VT100 > DSK MAXSRC)
	 (TLIMIT > DSK JIM) (LIMIT > DSK JIM)
	 (ASKP > DSK JIM) (DEFINT > DSK PAULW) (RESIDU > DSK PAULW)
	 (SPRDET > DSK PAULW) (ALGFAC > DSK PAULW) (IRINTE > DSK MAXSRC)
	 (NEWINV > DSK PAULW) (LINNEW > DSK PAULW) (EZGCD > DSK RAT)
	 (EEZ > DSK PAULW) (NEWFAC > DSK PAULW) (HOMOG > DSK RAT)
	 (UFACT > DSK RAT) (RPART > DSK MACRAK) (LOGARC > DSK MACRAK)
	 (SERIES > DSK RZ) (NUMTH > DSK RZ) (HAYAT > DSK RAT)
	 (SCHATC > DSK RZ) (TRGRED > DSK RZ) (NEWDET > DSK RAT)
	 (POLYRZ > DSK RAT) (ALGSYS > DSK RAT) (NISIMP > DSK RAT)
	 (NALGFA > DSK RAT) (LAPLAC > DSK MAXSRC) (CPOLY > DSK CFFK)
	 (PADE > DSK RAT) (SUMCON > DSK MAXSRC) (SYNEX > DSK MAXSRC)
	 (SUBLIS > DSK MAXSRC) (MMACRO > DSK REH) (BUILDQ > DSK REH)
	 (RESET > DSK ALJABR)))
 'FILES2)

; The following are out-of-core "SPLITFILES"
(PROG2 
 (SETQ FILES3  ; FASL file and UNFASL file to MAXOUT; 
       '((COMM2 > DSK JPG) (CSIMP2 > DSK PAULW) (PLOT > DSK JPG)
	 (PSOLVE > DSK RAT) (OUTMIS > DSK MAXSRC) (COMBIN > DSK RZ)
	 (TRIGO > DSK MRG) (RATOUT > DSK RAT) (RESULT > DSK RAT)
	 (MSTUFF > DSK DAS) (SPECFN > DSK WGD) (DESCRI > DSK MAXSRC)))
 'FILES3 
 ;; Note that MSCOMP and MAKLAP1 get interned here while OBARRAY is
 ;; bound to SOBARRAY.  This seems to be why they can be typed from
 ;; the compiler Lisp level.
 ((LAMBDA (OBARRAY NM) 
	  (SET (SETQ NM (INTERN NM)) (APPEND '(MSCOMP MAKLAP1) (SYMEVAL NM))))
      SOBARRAY 'SAIL-MORE-SYSFUNS))

(DEFUN MSCOMP NIL
 ((LAMBDA (MUZZLEDP)
   (MSCOMP1 FILES1 T NIL) (MSCOMP1 FILES2 NIL NIL) (MSCOMP1 FILES3 NIL T)) T))

(DEFUN MSCOMP1 (FILES COREP SPLITP)
   ((LAMBDA (DEFAULTF ODEFAULTF)
       (PROG (FILE UNFILE IN OUT EXP EXP1 MACSYMP)
	A    (COND ((NULL FILES) (RETURN '|All finished|)))
	     (APPLY 'UREAD (SETQ FILE (CAR FILES)))
	     (SETQ IN (STATUS UREAD))
	     (SETQ OUT (COND ((AND OUT1 (NOT FASLP)) OUT1)
			     (OUT1 (CONS (CAR OUT1) (CONS 'LAP (CDDR OUT1))))
			     (SPLITP (CONS (CAR FILE) '(LAP DSK MAXOUT)))
			     (COREP (CONS (CAR FILE) '(LAP DSK MAXDMP)))
			     ((EQ (CAR (LAST IN)) 'LIBMAX)
			      (CONS (CAR FILE) '(LAP DSK LIBMAX)))
			     (T (CONS (CAR FILE) '(LAP DSK MACSYM)))))
	     (SETQ MACSYMP (MEMQ (CADDDR OUT) '(MACSYM MAXDMP)))
	     (COND ((OR REDOALL
			(AND (NULL (PROBEF (SETQ UNFILE
						 (CONS (CAR OUT)
						       (CONS 'UNFASL (CDDR OUT))))))
			     (OR (NOT MACSYMP)
				 (NULL (PROBEF (SETQ UNFILE
						     (CONS (CAR OUT)
							   '(UNFASL DSK MUNFAS))))))))
		    (GO B)))
	     (APPLY 'UREAD UNFILE)
	     (SETQ ^Q T)
	     (SETQ EXP (CADR (READ)) EXP1 (PROG2 (READ) (CADR (READ))))
	     (COND ((EQ (CAR EXP1) 'THIS) (SETQ EXP EXP1)))
	     (SETQ EXP (CAR (LAST EXP)))
	     (SETQ ^Q NIL)
	     (COND ((EQ (CADR IN) (COND ((ATOM (CAR EXP)) (CADR EXP)) (T (CADDR EXP))))
		    (PRINT (CONS IN '(WAS ALREADY COMPILED AND ASSEMBLED)))
		    (GO C)))
	B    ;(INITIALIZE)
	     ;; This is needed to make calls to FORMAT work at compile time.
	     ;; They are necessary because the obarrays are reset.
	     (SSTATUS UUOLINKS)
;	     (REMPROP 'FORMAT 'LSUBR)
;	     (REMPROP 'FORMAT 'VERSION)
;	     (LOAD "LIBLSP;LOOP")
	     ;; Figure out some better way of initializing the (STATUS FEATURES)
	     ;; list to its initial state.  (INITIALIZE) should actually be doing
	     ;; this.  This simply flushes all entries beginning with LIBMAX from
	     ;; the list.  Note that (SSTATUS NOFEATURE LIBMAX-MACROS) explicitly
	     ;; doesn't work because of obarray problems.
	     (SSTATUS-FEATURE-MACSYMA-COMPLR)
	     (DO ((L (STATUS FEATURES) (CDR L))
		  (FEATURE) (X))
		 ((NULL L))
		 (SETQ FEATURE (CAR L))
		 (SETQ X (EXPLODEN FEATURE))
		 (COND ((> (LENGTH X) 5) (RPLACD (CDR (CDDDDR X)) NIL)))
		 (SETQ X (MAKNAM X))
		 (COND ((SAMEPNAMEP X 'LIBMAX)
			(APPLY 'SSTATUS (LIST 'NOFEATURE FEATURE))))
		 (COND ((SAMEPNAMEP X 'IOTA)
			(APPLY 'SSTATUS (LIST 'NOFEATURE FEATURE)))))
	     (SETQ DEFAULTF ODEFAULTF)
	     (SETQ MAPEX NIL BARFP T DATAERRP T LISPERRP T TTYNOTES T
		   YESWARNTTY T MUZZLED T ARRAYOPEN T IBASE 10. BASE 10.
		   *NOPOINT NIL USE-STRT7 T DEFMACRO-FOR-COMPILING NIL
		   MESSAGES-INITIALIZED NIL
		   DEFMACRO-DISPLACE-CALL NIL)
	     (COND (FASLP (SETQ FASL T UNFASLCOMMENTS T NOLAP T
				OUT (OR OUT1 (CONS (CAR OUT) (CONS 'FASL (CDDR OUT)))))
			  (COND (MACSYMP (SETQ MSDIR MMSDIR)))))
	     (COND ((NULL TTYNOTESP) (SETQ TTYNOTES NIL)))
	     (COND ((NULL YESWARNTTYP) (SETQ YESWARNTTY NIL)))
	     (COND ((NULL UNFASLCOMMENTSP) (SETQ UNFASLCOMMENTS NIL)))
	     (COND ((NULL NOLAPP) (SETQ NOLAP NIL)))
	     (COND ((NULL MUZZLEDP) (SETQ MUZZLED NIL)))
	     (COND (MAPEXP (SETQ MAPEX T)))
	     (PRINT (CONS IN '(COMPILATION BEGUN)))
	     (COND (FILEONE (BREAK FILE-ONE-DONE T)))
	     (APPLY 'MAKLAP (LIST OUT IN))
	     (PRINT (CONS IN '(COMPILATION ENDED)))
	     (SETQ FILEONE T)
	C    (SETQ FILES (CDR FILES))
	     (GO A)))
     DEFAULTF  DEFAULTF))

(DEFUN MAKLAP1 FEXPR (L)
 (PROG (OUT1)
       (COND ((CDR L) (COND ((CDDR L) (PRINC '/
MAKLAP1/ TAKES/ ONLY/ 1/ OR/ 2/ ARGS/.) (ERR)))
		      (APPLY 'CRUNIT (CDDAR L))
		      (SETQ OUT1 (CAR L) L (CDR L)) (ARGCHK OUT1))
	     (T (ARGCHK (CAR L))))
       (RETURN (MSCOMP1 L (ASSQ (CAAR L) FILES1) (ASSQ (CAAR L) FILES3)))))

(DEFUN MCOMPILE FEXPR (L)
 (LET ((TTYNOTESP NIL) (MUZZLEDP T)) (APPLY 'MAKLAP1 L)))

(DEFUN ARGCHK (L)
 (COND ((NOT (= (LENGTH L) 4)) (PRINT L) (PRINC '/
ARG/ TO/ MAKLAP1/ MUST/ BE/ OF/ LENGTH/ 4) (ERR))))
